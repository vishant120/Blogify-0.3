<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Blogify | Home</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Font-Awesome 6 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <!-- Moment.js (only if you want relative time) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

  <style>
    :root {
      --bg: #0f1114;
      --card: #1a1d21;
      --primary: #1abc9c;
      --danger: #e74c3c;
      --text: #e1e3e6;
      --muted: #7f8489;
      --radius: 14px;
      --shadow: 0 8px 32px rgba(0,0,0,.35);
      --transition: .25s ease;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
    }
    body {
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    a {
      color: var(--primary);
      text-decoration: none;
    }
    img {
      max-width: 100%;
      display: block;
    }

    /* ---------- HEADER ---------- */
    header {
      position: sticky;
      top: 0;
      z-index: 1000;
      background: #15171c;
      border-bottom: 1px solid #25282e;
      padding: .75rem 1rem;
    }
    .nav {
      max-width: 1200px;
      margin: auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: 1px;
    }
    .nav-links {
      display: flex;
      gap: 1.2rem;
      align-items: center;
    }
    .nav-links a {
      font-size: .9rem;
      transition: var(--transition);
    }
    .nav-links a:hover {
      color: #fff;
    }
    .btn {
      background: var(--primary);
      color: #000;
      padding: .45rem 1.1rem;
      border-radius: 8px;
      font-weight: 600;
      font-size: .85rem;
      border: none;
      cursor: pointer;
      transition: var(--transition);
    }
    .btn:hover {
      filter: brightness(1.1);
    }

    /* ---------- MAIN ---------- */
    main {
      flex: 1;
      max-width: 1200px;
      width: 100%;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    .section-title {
      font-size: 1.8rem;
      margin-bottom: 1.2rem;
      display: flex;
      align-items: center;
      gap: .5rem;
    }

    /* ---------- BLOG CARD ---------- */
    .blogs {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.8rem;
    }
    .blog-card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: transform var(--transition), box-shadow var(--transition);
    }
    .blog-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0,0,0,.45);
    }
    .cover {
      height: 180px;
      object-fit: cover;
      width: 100%;
    }
    .content {
      padding: 1.2rem;
      display: flex;
      flex-direction: column;
      flex: 1;
    }
    .author-row {
      display: flex;
      align-items: center;
      gap: .6rem;
      margin-bottom: .7rem;
    }
    .author-ava {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      object-fit: cover;
    }
    .author-name {
      font-size: .85rem;
      font-weight: 600;
    }
    .time {
      font-size: .75rem;
      color: var(--muted);
      margin-left: auto;
    }
    .blog-title {
      font-size: 1.15rem;
      font-weight: 700;
      margin-bottom: .5rem;
      line-height: 1.3;
    }
    .excerpt {
      font-size: .92rem;
      color: var(--muted);
      line-height: 1.5;
      margin-bottom: 1rem;
      flex: 1;
    }
    .actions {
      display: flex;
      align-items: center;
      gap: .6rem;
      flex-wrap: wrap;
    }
    .act {
      background: transparent;
      border: 1px solid #333;
      color: var(--text);
      padding: .4rem .8rem;
      border-radius: 8px;
      font-size: .8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: .4rem;
      transition: var(--transition);
    }
    .act:hover {
      border-color: var(--primary);
      color: var(--primary);
    }
    .act.liked {
      background: var(--danger);
      border-color: var(--danger);
      color: #fff;
    }

    /* ---------- MODAL ---------- */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.65);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 2000;
    }
    .modal.show {
      display: flex;
    }
    .drawer {
      background: #1a1d21;
      width: 100%;
      max-width: 600px;
      height: 75vh;
      border-top-left-radius: var(--radius);
      border-top-right-radius: var(--radius);
      transform: translateY(100%);
      transition: transform var(--transition);
      display: flex;
      flex-direction: column;
    }
    .modal.show .drawer {
      transform: translateY(0);
    }
    .drawer-header {
      padding: 1rem 1.2rem;
      border-bottom: 1px solid #25282e;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .drawer-body {
      flex: 1;
      overflow-y: auto;
      padding: 1.2rem;
    }
    .close {
      background: none;
      border: none;
      color: var(--text);
      font-size: 1.4rem;
      cursor: pointer;
    }
    .user-row {
      display: flex;
      align-items: center;
      gap: .8rem;
      padding: .6rem 0;
    }
    .user-row img {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      object-fit: cover;
    }
    .user-name {
      font-weight: 600;
      font-size: .95rem;
    }

    /* ---------- FOOTER ---------- */
    footer {
      text-align: center;
      padding: 2rem 1rem 1.5rem;
      font-size: .8rem;
      color: var(--muted);
    }

    /* ---------- RESPONSIVE ---------- */
    @media (max-width: 600px) {
      .nav-links {
        gap: .8rem;
      }
      .section-title {
        font-size: 1.4rem;
      }
      .blogs {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

  <!-- ================= HEADER ================= -->
  <header>
    <div class="nav">
      <div class="logo"><i class="fa-solid fa-blog"></i> Blogify</div>
      <div class="nav-links">
        <% if (user) { %>
          <a href="/"><i class="fa-solid fa-house"></i> Home</a>
          <a href="/blog/addBlog"><i class="fa-solid fa-plus"></i> Write</a>
          <a href="/notifications"><i class="fa-solid fa-bell"></i></a>
          <a href="/settings"><i class="fa-solid fa-gear"></i></a>
          <a href="/profile/<%= user._id %>">
            <img src="<%= user.profileImageURL %>" alt="avatar" style="width:28px;height:28px;border-radius:50%;vertical-align:middle;">
          </a>
          <a href="/logout"><button class="btn">Logout</button></a>
        <% } else { %>
          <a href="/login">Login</a>
          <a href="/register"><button class="btn">Join Now</button></a>
        <% } %>
      </div>
    </div>
  </header>

  <!-- ================= MAIN ================= -->
  <main>
    <h1 class="section-title"><i class="fa-solid fa-newspaper"></i> Latest Stories</h1>

    <!-- success / error flash -->
    <% if (success_msg) { %>
      <div style="background:#1a6d1a;padding:.8rem 1rem;border-radius:8px;margin-bottom:1.2rem;font-size:.9rem;">
        <i class="fa-solid fa-circle-check"></i> <%= success_msg %>
      </div>
    <% } %>
    <% if (error_msg) { %>
      <div style="background:#b32d2d;padding:.8rem 1rem;border-radius:8px;margin-bottom:1.2rem;font-size:.9rem;">
        <i class="fa-solid fa-circle-exclamation"></i> <%= error_msg %>
      </div>
    <% } %>

    <!-- BLOGS GRID -->
    <div class="blogs">
      <% blogs.forEach(blog => { %>
        <article class="blog-card">
          <% if (blog.coverImage) { %>
            <img src="<%= blog.coverImage %>" alt="cover" class="cover">
          <% } %>
          <div class="content">
            <div class="author-row">
              <img src="<%= blog.createdBy.profileImageURL %>" alt="avatar" class="author-ava">
              <a href="/profile/<%= blog.createdBy._id %>" class="author-name"><%= blog.createdBy.fullname %></a>
              <span class="time"><%= moment(blog.createdAt).fromNow() %></span>
            </div>

            <a href="/blog/<%= blog._id %>" class="blog-title"><%= blog.title %></a>
            <p class="excerpt"><%= blog.body.length > 120 ? blog.body.substring(0,120)+'…' : blog.body %></p>

            <div class="actions">
              <% if (user) { %>
                <button class="act ajax-like <%= blog.likes.some(l=>l._id.toString()===user._id.toString()) ? 'liked' : '' %>"
                        data-blog="<%= blog._id %>"
                        data-liked="<%= blog.likes.some(l=>l._id.toString()===user._id.toString()) %>">
                  <i class="<%= blog.likes.some(l=>l._id.toString()===user._id.toString()) ? 'fa-solid' : 'fa-regular' %> fa-heart"></i>
                  <span class="like-count"><%= blog.likes.length %></span>
                </button>

                <% if (blog.createdBy._id.toString() !== user._id.toString()) { %>
                  <button class="act ajax-follow"
                          data-user="<%= blog.createdBy._id %>"
                          data-status="<%= blog.followStatus %>">
                    <i class="fa-solid <%= blog.followStatus==='following' ? 'fa-user-minus' : 'fa-user-plus' %>"></i>
                    <span class="follow-text"><%= blog.followStatus==='following' ? 'Unfollow' : 'Follow' %></span>
                  </button>
                <% } %>
              <% } %>

              <button class="act" onclick="showLikes('<%= blog._id %>')">
                <i class="fa-solid fa-thumbs-up"></i> Likes
              </button>
              <button class="act" onclick="showComments('<%= blog._id %>')">
                <i class="fa-solid fa-comment"></i> Comments
              </button>

              <a href="/blog/<%= blog._id %>" class="act">
                <i class="fa-solid fa-arrow-right"></i> Read
              </a>
            </div>
          </div>
        </article>
      <% }) %>
    </div>
  </main>

  <!-- ================= FOOTER ================= -->
  <footer>
    Made with <i class="fa-solid fa-heart" style="color:var(--danger)"></i> by Blogify &copy; <%= new Date().getFullYear() %>
  </footer>

  <!-- ================= MODAL ================= -->
  <div id="modal" class="modal" onclick="if(event.target===this) closeModal();">
    <div class="drawer">
      <div class="drawer-header">
        <h3 id="modal-title">Title</h3>
        <button class="close" onclick="closeModal()">&times;</button>
      </div>
      <div id="modal-body" class="drawer-body"></div>
    </div>
  </div>

  <!-- ================= SCRIPTS ================= -->
  <script>
    /* ---------- UTILS ---------- */
    const qs = (sel, ctx = document) => ctx.querySelector(sel);
    const qsa = (sel, ctx = document) => [...ctx.querySelectorAll(sel)];

    /* ---------- LIKE / FOLLOW ---------- */
    document.addEventListener('click', async e => {
      const likeBtn = e.target.closest('.ajax-like');
      if (likeBtn) {
        const blogId = likeBtn.dataset.blog;
        const liked = likeBtn.dataset.liked === 'true';
        const res = await fetch(`/blog/${blogId}/like`, {
          method: 'POST',
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        const data = await res.json();
        likeBtn.dataset.liked = data.isLiked;
        likeBtn.classList.toggle('liked', data.isLiked);
        qs('.like-count', likeBtn).textContent = data.likesCount;
        qs('i', likeBtn).className = data.isLiked ? 'fa-solid fa-heart' : 'fa-regular fa-heart';
      }

      const followBtn = e.target.closest('.ajax-follow');
      if (followBtn) {
        const userId = followBtn.dataset.user;
        let status = followBtn.dataset.status;
        let endpoint = status === 'following' ? '/user/unfollow/' : '/user/follow/';
        if (status === 'requested') endpoint = '/user/cancel-follow/';
        const res = await fetch(endpoint + userId, {
          method: 'POST',
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        const data = await res.json();
        followBtn.dataset.status = data.newStatus;
        qs('.follow-text', followBtn).textContent = data.newStatus === 'following' ? 'Unfollow' : 'Follow';
        qs('i', followBtn).className = data.newStatus === 'following' ? 'fa-solid fa-user-minus' : 'fa-solid fa-user-plus';
      }
    });

    /* ---------- MODAL HELPERS ---------- */
    function openModal(title, bodyHTML) {
      qs('#modal-title').textContent = title;
      qs('#modal-body').innerHTML = bodyHTML;
      qs('#modal').classList.add('show');
      document.body.style.overflow = 'hidden';
    }
    function closeModal() {
      qs('#modal').classList.remove('show');
      document.body.style.overflow = '';
    }

    /* ---------- SHOW LIKES ---------- */
    async function showLikes(blogId) {
      const res = await fetch(`/blog/${blogId}/likes`);
      const likes = await res.json();
      let html = '';
      if (!likes.length) html = '<p style="text-align:center;color:var(--muted)">No likes yet</p>';
      else {
        likes.forEach(u => {
          html += `
            <div class="user-row">
              <img src="${u.profileImageURL}" alt="avatar">
              <a href="/profile/${u._id}" class="user-name">${u.fullname}</a>
            </div>`;
        });
      }
      openModal('Likes', html);
    }

    /* ---------- SHOW COMMENTS ---------- */
    async function showComments(blogId) {
      const res = await fetch(`/blog/${blogId}/comments`);
      const comments = await res.json();
      let html = '';
      if (!comments.length) html = '<p style="text-align:center;color:var(--muted)">No comments yet</p>';
      else {
        comments.forEach(c => {
          html += `
            <div class="user-row">
              <img src="${c.createdBy.profileImageURL}" alt="avatar">
              <div>
                <a href="/profile/${c.createdBy._id}" class="user-name">${c.createdBy.fullname}</a>
                <div style="font-size:.8rem;color:var(--muted)">${c.content}</div>
              </div>
            </div>`;
        });
      }
      html += `
        <form action="/comment/${blogId}" method="POST" style="margin-top:1rem;display:flex;gap:.5rem">
          <input name="content" required placeholder="Write a comment…" style="flex:1;padding:.6rem;border-radius:8px;border:1px solid #333;background:#111;color:#fff">
          <button class="btn">Post</button>
        </form>`;
      openModal('Comments', html);
    }
  </script>
</body>
</html>
